apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-ci-config
  namespace: cicd
data:
  .gitlab-ci.yml: |
    stages:
      - security-scan
      - build
      - test
      - package
      - deploy-staging
      - integration-test
      - deploy-production

    variables:
      DOCKER_DRIVER: overlay2
      DOCKER_TLS_CERTDIR: "/certs"
      HARBOR_REGISTRY: "harbor.cortex.local"
      IMAGE_NAME: "${HARBOR_REGISTRY}/ai-services/document-intelligence"

    before_script:
      - echo $HARBOR_PASSWORD | docker login $HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin

    security-scan:
      stage: security-scan
      image: returntocorp/semgrep:latest
      script:
        - semgrep --config=auto --json --output=semgrep-report.json .
        - cat semgrep-report.json
      artifacts:
        reports:
          sast: semgrep-report.json
        expire_in: 1 week
      rules:
        - if: $CI_COMMIT_BRANCH

    dependency-check:
      stage: security-scan
      image: owasp/dependency-check:latest
      script:
        - dependency-check.sh --project "Document Intelligence" --scan . --format JSON --out dependency-check-report.json
      artifacts:
        reports:
          dependency_scanning: dependency-check-report.json
        expire_in: 1 week
      allow_failure: false

    build:
      stage: build
      image: docker:20.10.16
      services:
        - docker:20.10.16-dind
      script:
        - docker build -t $IMAGE_NAME:$CI_COMMIT_SHA .
        - docker build -t $IMAGE_NAME:latest .
        - docker push $IMAGE_NAME:$CI_COMMIT_SHA
        - docker push $IMAGE_NAME:latest
      rules:
        - if: $CI_COMMIT_BRANCH == "main"
        - if: $CI_COMMIT_BRANCH == "develop"

    unit-tests:
      stage: test
      image: python:3.9
      script:
        - pip install -r requirements-test.txt
        - pytest tests/unit/ --junitxml=unit-test-report.xml --cov=src --cov-report=xml
      artifacts:
        reports:
          junit: unit-test-report.xml
          coverage: coverage.xml
        expire_in: 1 week
      coverage: '/TOTAL.+?(\d+\%)$/'

    integration-tests:
      stage: test
      image: docker:20.10.16
      services:
        - docker:20.10.16-dind
        - redis:6.2
        - postgres:13
      script:
        - docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit
      artifacts:
        reports:
          junit: integration-test-report.xml
        expire_in: 1 week

    container-scan:
      stage: package
      image: aquasec/trivy:latest
      script:
        - trivy image --format json --output container-scan-report.json $IMAGE_NAME:$CI_COMMIT_SHA
        - trivy image --exit-code 1 --severity HIGH,CRITICAL $IMAGE_NAME:$CI_COMMIT_SHA
      artifacts:
        reports:
          container_scanning: container-scan-report.json
        expire_in: 1 week
      allow_failure: false

    deploy-staging:
      stage: deploy-staging
      image: bitnami/kubectl:latest
      environment:
        name: staging
        url: https://staging.cortex.local
      script:
        - kubectl config use-context staging-cluster
        - envsubst < k8s/deployment.yaml | kubectl apply -f -
        - kubectl rollout status deployment/document-intelligence-agent -n ai-services-staging
        - kubectl get pods -n ai-services-staging
      rules:
        - if: $CI_COMMIT_BRANCH == "develop"
      when: manual

    staging-e2e-tests:
      stage: integration-test
      image: cypress/included:latest
      script:
        - cypress run --config baseUrl=https://staging.cortex.local --spec "cypress/e2e/**/*.cy.js"
      artifacts:
        when: always
        reports:
          junit: cypress/results/junit.xml
        paths:
          - cypress/screenshots
          - cypress/videos
        expire_in: 1 week
      rules:
        - if: $CI_COMMIT_BRANCH == "develop"

    deploy-production:
      stage: deploy-production
      image: bitnami/kubectl:latest
      environment:
        name: production
        url: https://api.cortex.local
      script:
        - kubectl config use-context production-cluster
        - envsubst < k8s/deployment.yaml | kubectl apply -f -
        - kubectl rollout status deployment/document-intelligence-agent -n ai-services --timeout=600s
        - kubectl get pods -n ai-services
        - sleep 30
        - curl -f https://api.cortex.local/health || (kubectl rollout undo deployment/document-intelligence-agent -n ai-services && exit 1)
      rules:
        - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: false

    rollback-production:
      stage: deploy-production
      image: bitnami/kubectl:latest
      script:
        - kubectl config use-context production-cluster
        - kubectl rollout undo deployment/document-intelligence-agent -n ai-services
        - kubectl rollout status deployment/document-intelligence-agent -n ai-services --timeout=300s
      rules:
        - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      needs: []